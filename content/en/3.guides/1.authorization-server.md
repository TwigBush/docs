---
title: Authorization Server Setup
description: Deploy and configure TwigBush GNAP Authorization Server
navigation:
  icon: i-lucide-server
---

## Overview

This guide walks through deploying and configuring the TwigBush Authorization Server (AS) for production use. The AS handles grant requests, token issuance, and policy evaluation.

## Prerequisites

### System Requirements
- Go 1.22+ (for building from source)
- PostgreSQL 14+ or compatible database
- Docker & Docker Compose (optional)
- 2GB RAM minimum
- 10GB disk space

### Network Requirements
- HTTPS endpoint (production)
- Valid TLS certificate
- Accessible JWKS endpoint

## Installation Methods

### From Source

```bash
# Clone repository
git clone https://github.com/TwigBush/TwigBush.git
cd TwigBush

# Build the AS binary
go build -o twigbush-as ./cmd/as

# Run the server
./twigbush-as
```

### Using Docker

```bash
# Pull the latest image
docker pull ghcr.io/twigbush/as:latest

# Run with environment variables
docker run -d \
  --name twigbush-as \
  -p 8085:8085 \
  -e DATABASE_URL=postgresql://user:pass@db/gnap \
  -e GNAP_HOST=as.example.com \
  ghcr.io/twigbush/as:latest
```

### Docker Compose

Create `docker-compose.yml`:

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: gnap
      POSTGRES_USER: gnap_user
      POSTGRES_PASSWORD: secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - gnap_network

  twigbush-as:
    image: ghcr.io/twigbush/as:latest
    ports:
      - "8085:8085"
    environment:
      DATABASE_URL: postgresql://gnap_user:secure_password@postgres/gnap
      GNAP_HOST: localhost
      GNAP_PORT: 8085
      TOKEN_TTL: 300
      LOG_LEVEL: info
    depends_on:
      - postgres
    networks:
      - gnap_network

volumes:
  postgres_data:

networks:
  gnap_network:
```

Start the stack:

```bash
docker-compose up -d
```

## Configuration

### Environment Variables

```bash
# Server Configuration
GNAP_HOST=as.example.com           # Public hostname
GNAP_PORT=8085                     # Listen port
GNAP_BASE_URL=https://as.example.com # Public base URL

# Database
DATABASE_URL=postgresql://user:pass@localhost/gnap
DATABASE_MAX_CONNECTIONS=25
DATABASE_IDLE_CONNECTIONS=5

# Security
TOKEN_TTL=300                      # Token lifetime in seconds
TOKEN_ISSUER=https://as.example.com
SIGNING_KEY_PATH=/path/to/key.pem
SIGNING_KEY_ID=primary-key-2024

# TLS Configuration
TLS_ENABLED=true
TLS_CERT_PATH=/path/to/cert.pem
TLS_KEY_PATH=/path/to/key.pem

# Policy Engine
OPENFGA_ENABLED=false
OPENFGA_URL=http://localhost:8080
OPENFGA_STORE_ID=01ARZ3NDEKTSV4R

# Logging
LOG_LEVEL=info                     # debug, info, warn, error
LOG_FORMAT=json                    # json or text
AUDIT_LOG_PATH=/var/log/gnap/audit.log

# Monitoring
METRICS_ENABLED=true
METRICS_PORT=9090
HEALTH_CHECK_PATH=/health
```

### Configuration File

Create `config.yaml`:

```yaml
server:
  host: as.example.com
  port: 8085
  base_url: https://as.example.com

database:
  url: postgresql://user:pass@localhost/gnap
  max_connections: 25
  idle_connections: 5

security:
  token_ttl: 300
  issuer: https://as.example.com
  signing_keys:
    - id: primary-key-2024
      path: /path/to/key.pem
      algorithm: RS256
    - id: backup-key-2024
      path: /path/to/backup.pem
      algorithm: ES256

tls:
  enabled: true
  cert_path: /path/to/cert.pem
  key_path: /path/to/key.pem

policy:
  engine: openfga
  openfga:
    url: http://localhost:8080
    store_id: 01ARZ3NDEKTSV4R

logging:
  level: info
  format: json
  outputs:
    - type: stdout
    - type: file
      path: /var/log/gnap/server.log
    - type: audit
      path: /var/log/gnap/audit.log
```

Load configuration:

```bash
./twigbush-as --config config.yaml
```

## Database Setup

### PostgreSQL Schema

```sql
-- Create database
CREATE DATABASE gnap;

-- Connect to database
\c gnap;

-- Run migrations
./twigbush-as migrate up
```

### Manual Schema Creation

```sql
-- Grants table
CREATE TABLE grants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    client_key JSONB NOT NULL,
    access_token JSONB,
    continue_token VARCHAR(255),
    continue_uri VARCHAR(255),
    interact_ref VARCHAR(255),
    state VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP
);

-- Access tokens table
CREATE TABLE access_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    token_value VARCHAR(255) UNIQUE NOT NULL,
    grant_id UUID REFERENCES grants(id),
    client_key JSONB NOT NULL,
    access JSONB NOT NULL,
    flags JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,
    revoked_at TIMESTAMP
);

-- Audit log table
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    event_type VARCHAR(50) NOT NULL,
    grant_id UUID,
    token_id UUID,
    client_info JSONB,
    event_data JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX idx_grants_continue_token ON grants(continue_token);
CREATE INDEX idx_access_tokens_value ON access_tokens(token_value);
CREATE INDEX idx_audit_logs_event ON audit_logs(event_type, created_at);
```

## Key Management

### Generate Signing Keys

```bash
# RSA key pair
openssl genrsa -out private.pem 4096
openssl rsa -in private.pem -pubout -out public.pem

# ECDSA key pair
openssl ecparam -genkey -name secp384r1 -out ec-private.pem
openssl ec -in ec-private.pem -pubout -out ec-public.pem
```

### Key Rotation

```bash
# Generate new key
./twigbush-as keys rotate --algorithm RS256

# List active keys
./twigbush-as keys list

# Revoke old key (after transition period)
./twigbush-as keys revoke --id old-key-2023
```

## Policy Configuration

### OpenFGA Integration

```yaml
# openfga-model.dsl
model
  schema 1.1

type user

type resource
  relations
    define owner: [user]
    define reader: [user] or owner
    define writer: [user] or owner
    define admin: [user] or owner

type api
  relations
    define can_read: [user, resource#reader]
    define can_write: [user, resource#writer]
    define can_admin: [user, resource#admin]
```

Deploy model:

```bash
# Create store
fga store create --name twigbush

# Write model
fga model write --store-id $STORE_ID --file openfga-model.dsl
```

### Custom Policy Adapter

```go
// internal/policy/custom.go
type CustomPolicyEngine struct {
    // Implementation
}

func (e *CustomPolicyEngine) Evaluate(ctx context.Context, req *PolicyRequest) (*PolicyResponse, error) {
    // Custom logic
    return &PolicyResponse{
        Allow: true,
        Constraints: map[string]interface{}{
            "max_ttl": 600,
            "required_scopes": []string{"api:read"},
        },
    }, nil
}
```

## Health Checks

### Readiness Check

```bash
curl http://localhost:8085/health/ready
```

Response:
```json
{
  "status": "ready",
  "checks": {
    "database": "healthy",
    "policy_engine": "healthy"
  }
}
```

### Liveness Check

```bash
curl http://localhost:8085/health/live
```

## Monitoring

### Prometheus Metrics

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'twigbush-as'
    static_configs:
      - targets: ['localhost:9090']
```

Available metrics:
- `gnap_grant_requests_total`
- `gnap_token_issued_total`
- `gnap_introspection_requests_total`
- `gnap_grant_duration_seconds`
- `gnap_active_tokens_gauge`

### Grafana Dashboard

Import dashboard from `deployments/grafana/dashboard.json`

## Production Checklist

### Security
- [ ] HTTPS enabled with valid certificate
- [ ] Strong database passwords
- [ ] Signing keys secured (HSM preferred)
- [ ] Audit logging enabled
- [ ] Rate limiting configured
- [ ] CORS settings restricted

### Performance
- [ ] Database connection pooling
- [ ] Redis cache (if needed)
- [ ] Load balancer configured
- [ ] Horizontal scaling ready

### Reliability
- [ ] Database backups scheduled
- [ ] Key rotation policy defined
- [ ] Monitoring alerts configured
- [ ] Disaster recovery plan
- [ ] Health checks integrated

### Compliance
- [ ] GDPR compliance (if applicable)
- [ ] Audit trail retention policy
- [ ] Security scanning enabled
- [ ] Penetration testing completed

## Troubleshooting

### Common Issues

#### Database Connection Failed
```bash
# Check connection
psql $DATABASE_URL -c "SELECT 1"

# Verify credentials
echo $DATABASE_URL
```

#### Token Validation Errors
```bash
# Check JWKS endpoint
curl https://as.example.com/.well-known/jwks.json

# Verify key configuration
./twigbush-as keys validate
```

#### Performance Issues
```bash
# Check database queries
./twigbush-as debug slow-queries

# Monitor goroutines
curl http://localhost:8085/debug/pprof/goroutine
```

### Debug Mode

```bash
# Enable debug logging
LOG_LEVEL=debug ./twigbush-as

# Enable pprof
DEBUG_ENABLED=true ./twigbush-as
```

## Next Steps

- [Resource Server Integration](/en/guides/resource-server) - Protect your APIs
- [Client Implementation](/en/guides/gnap-client) - Build GNAP clients
- [Policy Configuration](/en/guides/policy-engine) - Advanced authorization rules